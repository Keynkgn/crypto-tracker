<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crypto Trading Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:       #080B14;
    --surface:  #0D1120;
    --card:     #111827;
    --border:   #1E293B;
    --accent:   #6EE7B7;
    --accent2:  #38BDF8;
    --warn:     #F59E0B;
    --red:      #F87171;
    --green:    #34D399;
    --text:     #E2E8F0;
    --muted:    #64748B;
    --mono:     'JetBrains Mono', monospace;
    --sans:     'Syne', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--mono);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grid bg */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(110,231,183,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(110,231,183,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .wrap { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 24px 20px; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 28px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
    gap: 12px;
  }

  .logo { display: flex; align-items: center; gap: 12px; }
  .logo-icon {
    width: 40px; height: 40px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 10px;
    display: grid; place-items: center;
    font-size: 20px;
  }
  .logo h1 {
    font-family: var(--sans);
    font-weight: 800;
    font-size: 1.4rem;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: -0.5px;
  }
  .logo span { font-size: 0.7rem; color: var(--muted); display: block; margin-top: -2px; }

  .header-right { display: flex; align-items: center; gap: 12px; }

  .status-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 8px var(--green);
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%,100% { opacity: 1; } 50% { opacity: 0.4; }
  }
  #last-update { font-size: 0.7rem; color: var(--muted); }

  .btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: 0.75rem;
    padding: 7px 14px;
    border-radius: 8px;
    cursor: pointer;
    transition: all .2s;
    display: flex; align-items: center; gap: 6px;
  }
  .btn:hover { border-color: var(--accent); color: var(--accent); }
  .btn-primary {
    background: var(--accent);
    border-color: var(--accent);
    color: #000;
    font-weight: 700;
  }
  .btn-primary:hover { background: #5DD4A5; border-color: #5DD4A5; color: #000; }
  .btn-danger { border-color: #3B1515; color: var(--red); }
  .btn-danger:hover { border-color: var(--red); background: #1F0A0A; }

  /* ‚îÄ‚îÄ SUMMARY CARDS ‚îÄ‚îÄ */
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 24px;
  }

  .summary-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 16px 18px;
    transition: border-color .2s;
  }
  .summary-card:hover { border-color: var(--accent); }
  .summary-card .label { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
  .summary-card .value { font-size: 1.3rem; font-weight: 700; }
  .summary-card .sub { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }

  .pos { color: var(--green); }
  .neg { color: var(--red); }
  .neu { color: var(--accent2); }

  /* ‚îÄ‚îÄ COIN SECTION ‚îÄ‚îÄ */
  .coin-section { margin-bottom: 20px; }

  .coin-header {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px 14px 0 0;
    padding: 14px 18px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .coin-badge {
    background: linear-gradient(135deg, rgba(110,231,183,0.15), rgba(56,189,248,0.15));
    border: 1px solid rgba(110,231,183,0.3);
    border-radius: 8px;
    padding: 4px 10px;
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--accent);
  }

  .coin-price {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--accent2);
  }
  .coin-price.loading { color: var(--muted); font-size: 0.8rem; }

  .coin-pnl { font-size: 0.8rem; margin-left: auto; }

  .coin-actions { display: flex; gap: 8px; }

  /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
  .table-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-top: none;
    border-radius: 0 0 14px 14px;
    overflow-x: auto;
    margin-bottom: 0;
  }

  table { width: 100%; border-collapse: collapse; min-width: 780px; }

  thead th {
    font-size: 0.6rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted);
    padding: 10px 12px;
    text-align: left;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background .15s;
  }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: rgba(110,231,183,0.03); }

  td {
    padding: 11px 12px;
    font-size: 0.78rem;
    white-space: nowrap;
  }

  .td-date { color: var(--muted); font-size: 0.68rem; }
  .td-mono { font-family: var(--mono); }
  .td-right { text-align: right; }

  .badge-buy {
    background: rgba(52,211,153,0.15);
    color: var(--green);
    border: 1px solid rgba(52,211,153,0.3);
    border-radius: 6px;
    padding: 2px 8px;
    font-size: 0.7rem;
    font-weight: 700;
  }
  .badge-sell {
    background: rgba(248,113,113,0.15);
    color: var(--red);
    border: 1px solid rgba(248,113,113,0.3);
    border-radius: 6px;
    padding: 2px 8px;
    font-size: 0.7rem;
    font-weight: 700;
  }

  .del-btn {
    background: transparent; border: none; color: var(--muted);
    cursor: pointer; font-size: 14px; padding: 2px 6px;
    border-radius: 4px; transition: all .15s;
  }
  .del-btn:hover { color: var(--red); background: rgba(248,113,113,0.1); }

  /* ‚îÄ‚îÄ TOTALS ROW ‚îÄ‚îÄ */
  .totals-row td {
    background: rgba(110,231,183,0.05);
    font-weight: 700;
    border-top: 2px solid rgba(110,231,183,0.2);
    font-size: 0.8rem;
  }

  /* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
  @media (max-width: 640px) {
    .wrap { padding: 14px 12px; }
    header { gap: 10px; }
    .logo h1 { font-size: 1.1rem; }
    .logo span { display: none; }
    #last-update { display: none; }
    .header-right {
      width: 100%;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .header-right .btn { justify-content: center; font-size: 0.7rem; padding: 8px 6px; }
    .summary-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
    .summary-card { padding: 12px 14px; }
    .summary-card .value { font-size: 1.1rem; }
    .coin-header { padding: 12px 14px; gap: 8px; }
    .coin-price { font-size: 0.95rem; }
    .coin-pnl { width: 100%; margin-left: 0; }
    .coin-actions .btn { font-size: 0.68rem; padding: 5px 8px; }
    table, thead, tbody, th, td, tr { display: block; }
    thead { display: none; }
    tbody tr {
      border: 1px solid var(--border);
      border-radius: 10px;
      margin: 8px 12px;
      padding: 10px 12px;
      background: var(--card);
    }
    tbody tr.totals-row {
      background: rgba(110,231,183,0.05);
      border-color: rgba(110,231,183,0.2);
    }
    td {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
      border: none;
      font-size: 0.75rem;
      white-space: normal;
    }
    td::before {
      content: attr(data-label);
      font-size: 0.62rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      flex-shrink: 0;
      margin-right: 8px;
    }
    td:empty { display: none; }
    .table-wrap { overflow-x: visible; border-radius: 0 0 14px 14px; }
    table { min-width: unset; }
    .modal { padding: 20px 16px; margin: 12px; }
    .form-row { grid-template-columns: 1fr; }
  }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(8,11,20,0.85);
    backdrop-filter: blur(6px);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 18px;
    padding: 28px;
    width: 100%;
    max-width: 480px;
    box-shadow: 0 30px 80px rgba(0,0,0,0.5);
    animation: slideUp .25s ease;
  }
  @keyframes slideUp {
    from { opacity:0; transform: translateY(20px); }
    to   { opacity:1; transform: translateY(0); }
  }

  .modal h2 {
    font-family: var(--sans);
    font-size: 1.1rem;
    margin-bottom: 20px;
    color: var(--accent);
  }

  .form-group { margin-bottom: 14px; }
  .form-group label { display: block; font-size: 0.68rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
  .form-group input, .form-group select {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: 0.85rem;
    padding: 9px 12px;
    border-radius: 8px;
    outline: none;
    transition: border-color .2s;
  }
  .form-group input:focus, .form-group select:focus { border-color: var(--accent); }
  .form-group select option { background: var(--card); }

  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .modal-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }

  /* ‚îÄ‚îÄ ADD COIN MODAL ‚îÄ‚îÄ */
  #coin-suggestions {
    display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;
  }
  .suggestion {
    font-size: 0.7rem; padding: 4px 10px;
    border: 1px solid var(--border); border-radius: 6px;
    cursor: pointer; color: var(--muted);
    transition: all .15s;
  }
  .suggestion:hover { border-color: var(--accent); color: var(--accent); }

  /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
  .empty {
    text-align: center;
    padding: 30px;
    color: var(--muted);
    font-size: 0.8rem;
  }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  #toast {
    position: fixed; bottom: 24px; right: 24px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 18px;
    font-size: 0.78rem;
    transform: translateY(80px);
    opacity: 0;
    transition: all .3s;
    z-index: 200;
    max-width: 260px;
  }
  #toast.show { transform: translateY(0); opacity: 1; }

  .refresh-spin { animation: spin .6s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ NO COINS ‚îÄ‚îÄ */
  .no-coins {
    background: var(--card);
    border: 1px dashed var(--border);
    border-radius: 14px;
    padding: 50px;
    text-align: center;
    color: var(--muted);
  }
  .no-coins .icon { font-size: 3rem; margin-bottom: 12px; }
  .no-coins h3 { font-family: var(--sans); color: var(--text); margin-bottom: 8px; }
  .no-coins p { font-size: 0.8rem; margin-bottom: 20px; }
</style>
</head>
<body>
<div class="wrap">

  <!-- HEADER -->
  <header>
    <div class="logo">
      <div class="logo-icon">‚Çø</div>
      <div>
        <h1>CryptoTracker</h1>
        <span>Registro de posiciones en tiempo real</span>
      </div>
    </div>
    <div class="header-right">
      <button class="btn" onclick="refreshPrices()"><span id="refresh-icon">‚Üª</span> Actualizar</button>
      <button class="btn" onclick="document.getElementById('binance-file-input').click()">üì• Importar Binance</button>
      <input type="file" id="binance-file-input" accept=".xlsx" style="display:none" onchange="importBinance(this)">
      <button class="btn btn-primary" onclick="openAddOrder()">+ Nueva Orden</button>
      <button class="btn" onclick="openAddCoin()">+ Moneda</button>
    </div>
  </header>

  <!-- SUMMARY -->
  <div class="summary-grid">
    <div class="summary-card">
      <div class="label">Total Invertido</div>
      <div class="value neu" id="sum-invested">$0.00</div>
      <div class="sub">USDT pagado</div>
    </div>
    <div class="summary-card">
      <div class="label">Valor Actual</div>
      <div class="value" id="sum-current">$0.00</div>
      <div class="sub">al precio actual</div>
    </div>
    <div class="summary-card">
      <div class="label">P&L Total</div>
      <div class="value" id="sum-pnl">$0.00</div>
      <div class="sub" id="sum-pnl-pct">0.00%</div>
    </div>
    <div class="summary-card">
      <div class="label">√ìrdenes</div>
      <div class="value neu" id="sum-orders">0</div>
      <div class="sub" id="sum-coins">0 monedas</div>
    </div>
  </div>

  <!-- COIN SECTIONS -->
  <div id="coins-container">
    <div class="no-coins" id="empty-state">
      <div class="icon">üöÄ</div>
      <h3>Sin posiciones a√∫n</h3>
      <p>Agrega una moneda y comienza a registrar tus √≥rdenes.</p>
      <button class="btn btn-primary" onclick="openAddCoin()">+ Agregar Moneda</button>
    </div>
  </div>

</div>

<!-- MODAL: NUEVA ORDEN -->
<div class="modal-overlay" id="modal-order">
  <div class="modal">
    <h2>üìù Nueva Orden</h2>
    <div class="form-group">
      <label>Moneda</label>
      <select id="order-coin"></select>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Fecha (UTC)</label>
        <input type="datetime-local" id="order-date">
      </div>
      <div class="form-group">
        <label>Tipo</label>
        <select id="order-type">
          <option value="BUY">BUY</option>
          <option value="SELL">SELL</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Precio de Orden (USDT)</label>
        <input type="number" id="order-price" placeholder="0.00" step="0.0001">
      </div>
      <div class="form-group">
        <label>Cantidad</label>
        <input type="number" id="order-qty" placeholder="0.000" step="0.001">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Precio Promedio (USDT)</label>
        <input type="number" id="order-avg" placeholder="0.00" step="0.0001">
      </div>
      <div class="form-group">
        <label>Llenado (cantidad)</label>
        <input type="number" id="order-filled" placeholder="0.000" step="0.001">
      </div>
    </div>
    <div class="form-group">
      <label>N√∫mero de Orden (opcional)</label>
      <input type="text" id="order-num" placeholder="ej. 12345678">
    </div>
    <div class="form-group">
      <label>Notas (opcional)</label>
      <input type="text" id="order-notes" placeholder="Estrategia, observaciones...">
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('modal-order')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveOrder()">Guardar Orden</button>
    </div>
  </div>
</div>

<!-- MODAL: NUEVA MONEDA -->
<div class="modal-overlay" id="modal-coin">
  <div class="modal">
    <h2>ü™ô Agregar Moneda</h2>
    <div class="form-group">
      <label>S√≠mbolo o nombre (CoinGecko ID)</label>
      <input type="text" id="coin-id-input" placeholder="ej. solana, bitcoin, ethereum..." oninput="filterSuggestions(this.value)">
      <div id="coin-suggestions"></div>
    </div>
    <p style="font-size:0.7rem;color:var(--muted);margin-top:8px;">
      El precio se actualiza autom√°ticamente desde CoinGecko cada 60 seg.
    </p>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('modal-coin')">Cancelar</button>
      <button class="btn btn-primary" onclick="addCoin()">Agregar</button>
    </div>
  </div>
</div>

<!-- MODAL: IMPORTAR BINANCE -->
<div class="modal-overlay" id="modal-binance">
  <div class="modal" style="max-width:520px">
    <h2>üì• Importar desde Binance</h2>
    <div id="binance-preview" style="font-size:0.75rem;color:var(--muted);margin-bottom:16px;"></div>
    <p style="font-size:0.7rem;color:var(--muted);margin-bottom:16px;">
      Se importar√°n solo las √≥rdenes con status <strong style="color:var(--accent)">Filled</strong>. Las √≥rdenes duplicadas (mismo n√∫mero) ser√°n ignoradas.
    </p>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('modal-binance')">Cancelar</button>
      <button class="btn btn-primary" id="btn-confirm-import" onclick="confirmImport()">Importar Todo</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let state = {
  coins: {},   // { coinId: { symbol, name, price, orders:[] } }
};

// Conocidas para sugerencias
const KNOWN_COINS = [
  { id: 'solana',   sym: 'SOL' },
  { id: 'bitcoin',  sym: 'BTC' },
  { id: 'ethereum', sym: 'ETH' },
  { id: 'binancecoin', sym: 'BNB' },
  { id: 'cardano',  sym: 'ADA' },
  { id: 'ripple',   sym: 'XRP' },
  { id: 'dogecoin', sym: 'DOGE' },
  { id: 'avalanche-2', sym: 'AVAX' },
  { id: 'polkadot', sym: 'DOT' },
  { id: 'matic-network', sym: 'MATIC' },
  { id: 'chainlink', sym: 'LINK' },
  { id: 'near',     sym: 'NEAR' },
  { id: 'tron',     sym: 'TRX' },
  { id: 'litecoin', sym: 'LTC' },
  { id: 'uniswap',  sym: 'UNI' },
];

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function init() {
  const saved = localStorage.getItem('cryptoTrackerState');
  if (saved) {
    try { state = JSON.parse(saved); } catch(e) {}
  } else {
    // Cargar datos de SOL de ejemplo
    state.coins['solana'] = {
      symbol: 'SOL',
      name: 'Solana',
      price: null,
      orders: [
        { id: uid(), date: '2025-06-12T17:43:42', type:'BUY', orderNum:'12467966762', price:160.21, qty:1.06,  avg:160.21, filled:1.06,   notes:'' },
        { id: uid(), date: '2025-06-12T17:33:37', type:'BUY', orderNum:'12467875990', price:159.78, qty:1.0,   avg:159.78, filled:1.0,    notes:'' },
        { id: uid(), date: '2025-06-05T22:43:36', type:'BUY', orderNum:'12379543829', price:144.6,  qty:1.037, avg:144.6,  filled:1.037,  notes:'' },
        { id: uid(), date: '2025-06-05T20:26:51', type:'BUY', orderNum:'12376500541', price:144.61, qty:0.422, avg:144.61, filled:0.422,  notes:'' },
        { id: uid(), date: '2025-06-05T20:26:27', type:'BUY', orderNum:'12376490743', price:144.63, qty:1.533, avg:144.63, filled:1.533,  notes:'' },
        { id: uid(), date: '2025-06-05T19:32:35', type:'BUY', orderNum:'12375026836', price:146.54, qty:1.0,   avg:146.54, filled:1.0,    notes:'' },
      ]
    };
  }
  render();
  refreshPrices();
  setInterval(refreshPrices, 300000);
}

function save() {
  localStorage.setItem('cryptoTrackerState', JSON.stringify(state));
}

function uid() { return Math.random().toString(36).slice(2,10); }

// ‚îÄ‚îÄ PRICES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Mapeo coinGecko id ‚Üí s√≠mbolo para APIs alternativas
const COIN_SYMBOLS = {
  'solana': 'SOL', 'bitcoin': 'BTC', 'ethereum': 'ETH',
  'binancecoin': 'BNB', 'cardano': 'ADA', 'ripple': 'XRP',
  'dogecoin': 'DOGE', 'avalanche-2': 'AVAX', 'polkadot': 'DOT',
  'matic-network': 'MATIC', 'chainlink': 'LINK', 'near': 'NEAR',
  'tron': 'TRX', 'litecoin': 'LTC', 'uniswap': 'UNI',
};

// 1) CoinGecko (gratis, sin key, funciona en EEUU)
async function fetchCoinGecko(ids) {
  const url = `https://api.coingecko.com/api/v3/simple/price?ids=${ids.join(',')}&vs_currencies=usd`;
  const res = await fetch(url, { signal: AbortSignal.timeout(6000) });
  if (!res.ok) throw new Error('CoinGecko error');
  const data = await res.json();
  const result = {};
  for (const id of ids) {
    if (data[id]?.usd) result[id] = data[id].usd;
  }
  if (!Object.keys(result).length) throw new Error('No data');
  return result;
}

// 2) Kraken (100% disponible en EEUU, sin restricciones)
async function fetchKraken(ids) {
  const result = {};
  await Promise.all(ids.map(async id => {
    const sym = (COIN_SYMBOLS[id] || state.coins[id]?.symbol || '').toUpperCase();
    if (!sym) return;
    // Kraken usa XBTUSD para BTC, resto normal
    const pair = sym === 'BTC' ? 'XBTUSD' : `${sym}USD`;
    try {
      const res = await fetch(`https://api.kraken.com/0/public/Ticker?pair=${pair}`, { signal: AbortSignal.timeout(6000) });
      const data = await res.json();
      if (data.error?.length) return;
      const key = Object.keys(data.result || {})[0];
      if (key) result[id] = parseFloat(data.result[key].c[0]);
    } catch(e) {}
  }));
  if (!Object.keys(result).length) throw new Error('Kraken no data');
  return result;
}

// 3) CoinCap (buena disponibilidad en EEUU)
async function fetchCoinCap(ids) {
  const result = {};
  await Promise.all(ids.map(async id => {
    try {
      const res = await fetch(`https://api.coincap.io/v2/assets/${id}`, { signal: AbortSignal.timeout(6000) });
      const data = await res.json();
      if (data.data?.priceUsd) result[id] = parseFloat(data.data.priceUsd);
    } catch(e) {}
  }));
  if (!Object.keys(result).length) throw new Error('CoinCap no data');
  return result;
}

async function refreshPrices() {
  const ids = Object.keys(state.coins);
  if (!ids.length) return;
  const icon = document.getElementById('refresh-icon');
  icon.classList.add('refresh-spin');

  let prices = null;
  let source = '';

  try { prices = await fetchCoinGecko(ids); source = 'CoinGecko'; } catch(e) {}
  if (!prices) { try { prices = await fetchKraken(ids); source = 'Kraken'; } catch(e) {} }
  if (!prices) { try { prices = await fetchCoinCap(ids); source = 'CoinCap'; } catch(e) {} }

  if (prices && Object.keys(prices).length) {
    for (const [id, price] of Object.entries(prices)) {
      if (state.coins[id]) state.coins[id].price = price;
    }
    save(); render();
    const t = new Date().toLocaleTimeString('es');
    document.getElementById('last-update').textContent = `${source} ¬∑ ${t}`;
    document.querySelector('.status-dot').style.background = 'var(--green)';
    document.querySelector('.status-dot').style.boxShadow = '0 0 8px var(--green)';
    toast(`Precios actualizados via ${source} ‚úì`, 'pos');
  } else {
    document.getElementById('last-update').textContent = 'Sin conexi√≥n';
    document.querySelector('.status-dot').style.background = 'var(--red)';
    document.querySelector('.status-dot').style.boxShadow = '0 0 8px var(--red)';
    toast('No se pudo obtener precios', 'neg');
  }

  icon.classList.remove('refresh-spin');
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render() {
  const container = document.getElementById('coins-container');
  const emptyState = document.getElementById('empty-state');
  const coinIds = Object.keys(state.coins);

  if (!coinIds.length) {
    emptyState.style.display = '';
    container.innerHTML = '';
    container.appendChild(emptyState);
    updateSummary();
    return;
  }

  emptyState.style.display = 'none';
  container.innerHTML = '';

  for (const coinId of coinIds) {
    container.appendChild(renderCoin(coinId));
  }

  updateSummary();
}

function renderCoin(coinId) {
  const coin = state.coins[coinId];
  const { symbol, name, price, orders } = coin;

  // Stats
  let totalInvested = 0, totalFilled = 0, currentValue = 0;
  for (const o of orders) {
    if (o.type === 'BUY') {
      totalInvested += o.avg * o.filled;
      totalFilled += o.filled;
    } else {
      totalInvested -= o.avg * o.filled;
      totalFilled -= o.filled;
    }
  }
  if (price) currentValue = totalFilled * price;
  const pnl = price ? currentValue - totalInvested : null;
  const pnlPct = totalInvested ? (pnl / totalInvested * 100) : 0;

  const section = document.createElement('div');
  section.className = 'coin-section';
  section.id = `coin-${coinId}`;

  // Header
  const priceStr = price ? `$${fmtPrice(price)}` : '...';
  const pnlStr = pnl !== null
    ? `<span class="${pnl>=0?'pos':'neg'}">${pnl>=0?'+':''}$${fmt2(pnl)} (${pnl>=0?'+':''}${fmt2(pnlPct)}%)</span>`
    : `<span class="neu">‚Äî</span>`;

  section.innerHTML = `
    <div class="coin-header">
      <span class="coin-badge">${symbol}/USDT</span>
      <span style="color:var(--muted);font-size:0.75rem">${name}</span>
      <span class="coin-price ${price?'':'loading'}" id="price-${coinId}">${priceStr}</span>
      <span class="coin-pnl" style="margin-right:4px">P&L: ${pnlStr}</span>
      <div class="coin-actions">
        <button class="btn" style="font-size:0.7rem;padding:5px 10px" onclick="openAddOrder('${coinId}')">+ Orden</button>
        <button class="btn btn-danger" style="font-size:0.7rem;padding:5px 10px" onclick="removeCoin('${coinId}')">Eliminar</button>
      </div>
    </div>
    <div class="table-wrap">
      ${renderTable(coinId)}
    </div>
  `;

  return section;
}

function renderTable(coinId) {
  const coin = state.coins[coinId];
  const { price, orders } = coin;

  if (!orders.length) {
    return `<div class="empty">Sin √≥rdenes ‚Äî usa "+ Orden" para agregar.</div>`;
  }

  let totalInvested = 0, totalFilled = 0, totalCurrent = 0, totalPnl = 0;
  let rows = '';

  for (const o of orders) {
    const total = o.avg * o.filled;
    const curr = price ? price * o.filled : null;
    const pnl = curr !== null ? (o.type==='BUY' ? curr - total : total - curr) : null;
    const pnlPct = total ? (pnl / total * 100) : 0;

    if (o.type === 'BUY') { totalInvested += total; totalFilled += o.filled; }
    else { totalInvested -= total; totalFilled -= o.filled; }
    if (curr !== null) { totalCurrent += (o.type==='BUY' ? curr : -curr); totalPnl += pnl; }

    const dateStr = o.date ? o.date.replace('T',' ') : '‚Äî';
    const pnlCell = pnl !== null
      ? `<span class="${pnl>=0?'pos':'neg'}">${pnl>=0?'+':''}$${fmt2(pnl)}</span>`
      : '<span class="neu">‚Äî</span>';
    const pnlPctCell = pnl !== null
      ? `<span class="${pnl>=0?'pos':'neg'}">${pnl>=0?'+':''}${fmt2(pnlPct)}%</span>`
      : '<span class="neu">‚Äî</span>';
    const currCell = curr !== null ? `$${fmt2(curr)}` : '‚Äî';

    rows += `<tr>
      <td class="td-date" data-label="Fecha">${dateStr}</td>
      <td class="td-mono" data-label="Orden #" style="color:var(--muted);font-size:0.65rem">${o.orderNum || '‚Äî'}</td>
      <td data-label="Tipo"><span class="badge-${o.type.toLowerCase()}">${o.type}</span></td>
      <td class="td-right td-mono" data-label="Precio">$${fmtPrice(o.price)}</td>
      <td class="td-right td-mono" data-label="Cantidad">${fmt3(o.qty)}</td>
      <td class="td-right td-mono" data-label="Precio Avg">$${fmtPrice(o.avg)}</td>
      <td class="td-right td-mono" data-label="Llenado">${fmt3(o.filled)}</td>
      <td class="td-right td-mono" data-label="Total">$${fmt2(total)}</td>
      <td class="td-right td-mono" data-label="Valor Actual">${currCell}</td>
      <td class="td-right" data-label="P&L">${pnlCell}</td>
      <td class="td-right" data-label="P&L %">${pnlPctCell}</td>
      <td data-label="Notas" style="color:var(--muted);font-size:0.7rem">${o.notes || ''}</td>
      <td><button class="del-btn" onclick="deleteOrder('${coinId}','${o.id}')" title="Eliminar">‚úï</button></td>
    </tr>`;
  }

  // Totals
  const totalPnlCell = totalCurrent
    ? `<span class="${totalPnl>=0?'pos':'neg'}">${totalPnl>=0?'+':''}$${fmt2(totalPnl)}</span>` : '‚Äî';
  const totalPnlPct = totalInvested ? `<span class="${totalPnl>=0?'pos':'neg'}">${totalPnl>=0?'+':''}${fmt2(totalPnl/totalInvested*100)}%</span>` : '‚Äî';

  return `<table>
    <thead>
      <tr>
        <th>Fecha (UTC)</th>
        <th>Orden No.</th>
        <th>Tipo</th>
        <th class="td-right">Precio Orden</th>
        <th class="td-right">Cantidad</th>
        <th class="td-right">Precio Prom</th>
        <th class="td-right">Llenado</th>
        <th class="td-right">Total USDT</th>
        <th class="td-right">Valor Actual</th>
        <th class="td-right">P&L (USD)</th>
        <th class="td-right">P&L (%)</th>
        <th>Notas</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      ${rows}
      <tr class="totals-row">
        <td colspan="6" style="color:var(--muted)">TOTALES ‚Äî ${orders.length} √≥rdenes ¬∑ ${fmt3(totalFilled)} ${coin.symbol}</td>
        <td></td>
        <td class="td-right">$${fmt2(totalInvested)}</td>
        <td class="td-right">${totalCurrent ? '$'+fmt2(totalCurrent) : '‚Äî'}</td>
        <td class="td-right">${totalPnlCell}</td>
        <td class="td-right">${totalPnlPct}</td>
        <td colspan="2"></td>
      </tr>
    </tbody>
  </table>`;
}

function updateSummary() {
  let invested=0, current=0, orders=0;
  const coinCount = Object.keys(state.coins).length;
  for (const [id, coin] of Object.entries(state.coins)) {
    orders += coin.orders.length;
    for (const o of coin.orders) {
      const total = o.avg * o.filled;
      if (o.type==='BUY') { invested += total; if(coin.price) current += coin.price * o.filled; }
      else { invested -= total; if(coin.price) current -= coin.price * o.filled; }
    }
  }
  const pnl = current - invested;
  const pnlPct = invested ? (pnl / invested * 100) : 0;

  document.getElementById('sum-invested').textContent = '$'+fmt2(invested);
  const currEl = document.getElementById('sum-current');
  currEl.textContent = '$'+fmt2(current);
  currEl.className = 'value ' + (current >= invested ? 'pos' : 'neg');

  const pnlEl = document.getElementById('sum-pnl');
  pnlEl.textContent = (pnl>=0?'+':'') + '$'+fmt2(pnl);
  pnlEl.className = 'value ' + (pnl>=0?'pos':'neg');
  document.getElementById('sum-pnl-pct').textContent = (pnl>=0?'+':'') + fmt2(pnlPct)+'%';

  document.getElementById('sum-orders').textContent = orders;
  document.getElementById('sum-coins').textContent = coinCount + ' moneda' + (coinCount!==1?'s':'');
}

// ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openAddOrder(preselect) {
  const sel = document.getElementById('order-coin');
  sel.innerHTML = Object.entries(state.coins)
    .map(([id,c]) => `<option value="${id}" ${id===preselect?'selected':''}>${c.symbol} ‚Äî ${c.name}</option>`)
    .join('');
  document.getElementById('order-date').value = new Date().toISOString().slice(0,16);
  openModal('modal-order');
}

function saveOrder() {
  const coinId   = document.getElementById('order-coin').value;
  const date     = document.getElementById('order-date').value;
  const type     = document.getElementById('order-type').value;
  const price    = parseFloat(document.getElementById('order-price').value);
  const qty      = parseFloat(document.getElementById('order-qty').value);
  const avg      = parseFloat(document.getElementById('order-avg').value) || price;
  const filled   = parseFloat(document.getElementById('order-filled').value) || qty;
  const orderNum = document.getElementById('order-num').value.trim();
  const notes    = document.getElementById('order-notes').value.trim();

  if (!coinId || !date || isNaN(price) || isNaN(qty)) {
    toast('Completa los campos obligatorios', 'warn'); return;
  }

  state.coins[coinId].orders.unshift({ id: uid(), date, type, price, qty, avg, filled, orderNum, notes });
  save(); render();
  closeModal('modal-order');
  toast('Orden guardada ‚úì', 'pos');

  // clear
  ['order-price','order-qty','order-avg','order-filled','order-num','order-notes'].forEach(id => document.getElementById(id).value = '');
}

function deleteOrder(coinId, orderId) {
  if (!confirm('¬øEliminar esta orden?')) return;
  state.coins[coinId].orders = state.coins[coinId].orders.filter(o => o.id !== orderId);
  save(); render();
  toast('Orden eliminada', 'neg');
}

function openAddCoin() {
  document.getElementById('coin-id-input').value = '';
  renderSuggestions('');
  openModal('modal-coin');
}

function filterSuggestions(val) { renderSuggestions(val.toLowerCase()); }

function renderSuggestions(filter) {
  const box = document.getElementById('coin-suggestions');
  const shown = KNOWN_COINS.filter(c =>
    !state.coins[c.id] &&
    (c.sym.toLowerCase().includes(filter) || c.id.includes(filter))
  ).slice(0, 8);
  box.innerHTML = shown.map(c =>
    `<span class="suggestion" onclick="selectCoin('${c.id}','${c.sym}')">${c.sym}</span>`
  ).join('');
}

function selectCoin(id, sym) {
  document.getElementById('coin-id-input').value = id;
}

async function addCoin() {
  let input = document.getElementById('coin-id-input').value.trim().toLowerCase();
  if (!input) { toast('Escribe una moneda', 'warn'); return; }

  // Map symbol ‚Üí id
  const match = KNOWN_COINS.find(c => c.sym.toLowerCase() === input || c.id === input);
  const coinId = match ? match.id : input;

  if (state.coins[coinId]) { toast('Ya existe esa moneda', 'warn'); return; }

  toast('Buscando precio...', 'neu');

  try {
    const url = `https://api.coingecko.com/api/v3/simple/price?ids=${coinId}&vs_currencies=usd`;
    const res = await fetch(url);
    const data = await res.json();
    if (!data[coinId]) { toast('Moneda no encontrada en CoinGecko', 'warn'); return; }

    // Get name
    const infoRes = await fetch(`https://api.coingecko.com/api/v3/coins/${coinId}?localization=false&tickers=false&market_data=false&community_data=false&developer_data=false`);
    const info = await infoRes.json();

    state.coins[coinId] = {
      symbol: (info.symbol || coinId).toUpperCase(),
      name: info.name || coinId,
      price: data[coinId].usd,
      orders: []
    };
    save(); render();
    closeModal('modal-coin');
    toast(`${info.name} agregado ‚úì`, 'pos');
  } catch(e) {
    toast('Error conectando a CoinGecko', 'warn');
  }
}

function removeCoin(coinId) {
  const name = state.coins[coinId].name;
  if (!confirm(`¬øEliminar ${name} y todas sus √≥rdenes?`)) return;
  delete state.coins[coinId];
  save(); render();
  toast(`${name} eliminado`, 'neg');
}

// ‚îÄ‚îÄ MODAL HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// Close on overlay click
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) el.classList.remove('open'); });
});

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let toastTimer;
function toast(msg, type='neu') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.style.borderColor = type==='pos' ? 'var(--green)' : type==='neg' ? 'var(--red)' : 'var(--warn)';
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 3000);
}

// ‚îÄ‚îÄ FORMAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmt2(n) { return isNaN(n) ? '0.00' : Math.abs(n).toLocaleString('en-US', {minimumFractionDigits:2,maximumFractionDigits:2}); }
function fmt3(n) { return isNaN(n) ? '0.000' : n.toLocaleString('en-US', {minimumFractionDigits:3,maximumFractionDigits:3}); }
function fmtPrice(n) {
  if (n >= 1000) return n.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
  if (n >= 1)    return n.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:4});
  return n.toLocaleString('en-US', {minimumFractionDigits:4, maximumFractionDigits:8});
}

// ‚îÄ‚îÄ BINANCE IMPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Mapeo s√≠mbolo Binance ‚Üí CoinGecko ID
const SYMBOL_TO_ID = {
  'SOL': 'solana', 'BTC': 'bitcoin', 'ETH': 'ethereum',
  'BNB': 'binancecoin', 'ADA': 'cardano', 'XRP': 'ripple',
  'DOGE': 'dogecoin', 'AVAX': 'avalanche-2', 'DOT': 'polkadot',
  'MATIC': 'matic-network', 'LINK': 'chainlink', 'NEAR': 'near',
  'TRX': 'tron', 'LTC': 'litecoin', 'UNI': 'uniswap',
  'USDC': 'usd-coin', 'USDT': 'tether',
};

let pendingImport = [];

function importBinance(input) {
  const file = input.files[0];
  if (!file) return;
  input.value = '';

  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws);

      // Filtrar solo Filled
      const filled = rows.filter(r => r['Status'] === 'Filled');
      if (!filled.length) { toast('No hay √≥rdenes Filled en el archivo', 'warn'); return; }

      // Agrupar √≥rdenes existentes para detectar duplicados
      const existingOrderNums = new Set();
      for (const coin of Object.values(state.coins)) {
        for (const o of coin.orders) {
          if (o.orderNum) existingOrderNums.add(String(o.orderNum));
        }
      }

      // Procesar filas
      pendingImport = [];
      let duplicates = 0;
      for (const r of filled) {
        const orderNum = String(r['Order No.'] || '');
        if (existingOrderNums.has(orderNum)) { duplicates++; continue; }

        const baseAsset = (r['Base Asset'] || '').toUpperCase();
        const quoteAsset = (r['Quote Asset'] || '').toUpperCase();
        if (quoteAsset !== 'USDT') continue; // solo pares USDT

        const coinId = SYMBOL_TO_ID[baseAsset];
        if (!coinId) continue;

        pendingImport.push({
          coinId,
          symbol: baseAsset,
          date: r['Date(UTC)'] ? String(r['Date(UTC)']).replace(' ', 'T') : '',
          type: r['Type'],
          orderNum,
          price: parseFloat(r['Order Price']) || 0,
          qty: parseFloat(r['Order Amount']) || 0,
          avg: parseFloat(r['AvgTrading Price']) || parseFloat(r['Order Price']) || 0,
          filled: parseFloat(r['Filled']) || parseFloat(r['Order Amount']) || 0,
          notes: ''
        });
      }

      // Mostrar preview
      const bySymbol = {};
      for (const o of pendingImport) {
        bySymbol[o.symbol] = (bySymbol[o.symbol] || 0) + 1;
      }
      const previewLines = Object.entries(bySymbol).map(([sym, count]) => `‚Ä¢ ${sym}: ${count} √≥rdenes`).join('<br>');
      document.getElementById('binance-preview').innerHTML = `
        <strong style="color:var(--text)">Se importar√°n ${pendingImport.length} √≥rdenes:</strong><br><br>
        ${previewLines}
        ${duplicates ? `<br><br><span style="color:var(--warn)">‚ö† ${duplicates} duplicadas ignoradas</span>` : ''}
      `;

      if (!pendingImport.length) {
        toast('No hay √≥rdenes nuevas para importar', 'warn'); return;
      }

      openModal('modal-binance');
    } catch(err) {
      toast('Error leyendo el archivo: ' + err.message, 'neg');
    }
  };
  reader.readAsArrayBuffer(file);
}

async function confirmImport() {
  if (!pendingImport.length) return;
  document.getElementById('btn-confirm-import').textContent = 'Importando...';

  // Agregar monedas nuevas que no existen
  const newCoinIds = [...new Set(pendingImport.map(o => o.coinId))].filter(id => !state.coins[id]);

  for (const coinId of newCoinIds) {
    const sym = pendingImport.find(o => o.coinId === coinId)?.symbol || coinId;
    state.coins[coinId] = { symbol: sym, name: sym, price: null, orders: [] };
    // Intentar obtener nombre real de CoinGecko
    try {
      const res = await fetch(`https://api.coingecko.com/api/v3/coins/${coinId}?localization=false&tickers=false&market_data=false&community_data=false&developer_data=false`);
      const info = await res.json();
      if (info.name) state.coins[coinId].name = info.name;
    } catch(e) {}
  }

  // Agregar √≥rdenes
  for (const o of pendingImport) {
    state.coins[o.coinId].orders.unshift({
      id: uid(), date: o.date, type: o.type,
      orderNum: o.orderNum, price: o.price, qty: o.qty,
      avg: o.avg, filled: o.filled, notes: o.notes
    });
  }

  // Ordenar √≥rdenes por fecha desc
  for (const coin of Object.values(state.coins)) {
    coin.orders.sort((a, b) => new Date(b.date) - new Date(a.date));
  }

  save(); render();
  closeModal('modal-binance');
  document.getElementById('btn-confirm-import').textContent = 'Importar Todo';
  toast(`‚úì ${pendingImport.length} √≥rdenes importadas de Binance`, 'pos');
  pendingImport = [];
  refreshPrices();
}

// ‚îÄ‚îÄ START ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
init();
</script>
</body>
</html>
